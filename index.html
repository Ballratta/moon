<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moon Delivery</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <!-- Add Mali font -->
    <link href="https://fonts.googleapis.com/css2?family=Mali&display=swap" rel="stylesheet">
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- html2canvas CDN for generating image from HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: #F3E6FF; /* Set body background to light purple as per image */
        }
        /* Custom font for Moon Delivery title and Free Shipping */
        .moon-delivery-font {
            font-family: 'Mali', cursive; /* Changed to Mali font */
        }
        /* Custom styles for better visual */
        .product-card-image {
            object-fit: cover;
            width: 100%;
            height: 120px; /* Set fixed height for smaller product images */
            /* Removed aspect-ratio to allow fixed height */
        }
        .product-detail-image {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
        }
        .admin-sidebar button {
            transition: background-color 0.2s, color 0.2s;
        }
        .admin-sidebar button.active {
            background-color: #e0f2fe; /* bg-blue-100 */
            color: #1d4ed8; /* text-blue-700 */
            font-weight: 600; /* font-semibold */
        }

        /* Custom Modal Styles */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .custom-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .custom-modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 400px;
            width: 90%;
            text-align: center;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .custom-modal-overlay.show .custom-modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        /* Specific styles for password modal */
        #password-modal .custom-modal-content {
            padding: 1.5rem;
        }
        #password-modal input[type="password"] {
            width: 100%;
            padding: 0.75rem;
            margin-top: 1rem;
            margin-bottom: 1.5rem;
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        #password-modal input[type="password"]:focus {
            border-color: #3b82f6; /* focus:border-blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* focus:ring-blue-500 */
        }
        #password-modal .button-group {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        /* Styles for the receipt container (hidden by default) */
        #receipt-container {
            position: absolute;
            left: -9999px; /* Hide off-screen */
            top: -9999px;
            width: 300px; /* Fixed width for receipt image */
            padding: 20px;
            background-color: white;
            border: 1px solid #ddd;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            font-family: 'Inter', sans-serif;
            color: #333;
            box-sizing: border-box;
        }
        #receipt-container h2 {
            text-align: center;
            margin-bottom: 15px;
            font-size: 20px;
            color: #222;
        }
        #receipt-container .receipt-header,
        #receipt-container .receipt-footer {
            text-align: center;
            font-size: 12px;
            margin-bottom: 10px;
        }
        #receipt-container .receipt-item {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
        }
        #receipt-container .receipt-item:last-of-type {
            border-bottom: none;
        }
        #receipt-container .receipt-total {
            display: flex;
            justify-content: space-between;
            font-size: 16px;
            font-weight: bold;
            padding-top: 10px;
            border-top: 1px solid #ddd;
            margin-top: 10px;
        }

        /* New styles for category and store sections */
        .category-item, .store-item {
            flex-shrink: 0; /* Prevent items from shrinking */
            width: 100px; /* Fixed width for category/store items */
            text-align: center;
        }
        .category-item img, .store-item img {
            width: 60px; /* Adjust size as needed */
            height: 60px; /* Adjust size as needed */
            object-fit: contain; /* Ensure image fits without cropping */
            margin: 0 auto;
            border-radius: 9999px; /* For circular images if desired */
        }
    </style>
</head>
<body class="min-h-screen bg-purple-100 font-sans antialiased">

    <!-- Custom Modal for Alerts -->
    <div id="custom-alert-modal" class="custom-modal-overlay">
        <div class="custom-modal-content">
            <p id="custom-alert-message" class="text-lg text-gray-800 mb-6"></p>
            <button id="custom-alert-ok-button" class="bg-blue-600 text-white py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-200">
                ตกลง
            </button>
        </div>
    </div>

    <!-- Custom Modal for Password Input -->
    <div id="password-modal" class="custom-modal-overlay">
        <div class="custom-modal-content">
            <p class="text-lg text-gray-800 mb-4">กรุณาใส่รหัสผ่านเพื่อเข้าสู่หน้าจัดการเว็บไซต์:</p>
            <input type="password" id="password-input" placeholder="รหัสผ่าน">
            <div class="button-group">
                <button id="password-submit-button" class="bg-blue-600 text-white py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-200">
                    เข้าสู่ระบบ
                </button>
                <button id="password-cancel-button" class="bg-gray-300 text-gray-800 py-2 px-6 rounded-lg hover:bg-gray-400 transition duration-200">
                    ยกเลิก
                </button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-[#c8a1ffff] shadow-md p-4 sticky top-0 z-10"> <!-- Changed background color -->
        <div class="container mx-auto flex items-center justify-between">
            <!-- Left section: Moon Delivery Logo and Free Shipping -->
            <div class="flex flex-col items-start">
                <h1 class="text-4xl font-bold text-black moon-delivery-font"> <!-- Changed text color to black -->
                    <span class="text-black">Moon</span> Delivery <!-- Changed text color to black -->
                </h1>
                <div class="flex items-center text-black font-semibold text-sm mt-1 moon-delivery-font"> <!-- Applied Mali font and changed text color to black -->
                    <i data-lucide="truck" class="w-5 h-5 mr-1"></i>
                    ส่งฟรีไม่มีขั้นต่ำ
                </div>
            </div>

            <!-- Middle section: Search Input -->
            <div class="flex-grow mx-4 relative max-w-md">
                <input type="text" id="search-input" placeholder="ค้นหาสินค้า..."
                    class="w-full p-2 pl-10 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <i data-lucide="search" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>

            <!-- Right section: Cart and Admin buttons -->
            <div class="flex items-center space-x-4">
                <button id="cart-button" class="relative bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition duration-200 shadow-md">
                    <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                    <span id="cart-item-count" class="absolute -top-1 -right-1 bg-red-600 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">
                        0
                    </span>
                </button>
                <button id="admin-panel-button" class="text-gray-600 hover:text-blue-600 transition duration-200 font-semibold flex items-center" title="จัดการเว็บไซต์">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Category Navigation Bar -->
    <nav class="bg-white shadow-sm p-4 mt-4 mx-auto max-w-7xl rounded-lg overflow-x-auto whitespace-nowrap">
        <div class="flex space-x-6 justify-between md:justify-center">
            <div class="category-item flex flex-col items-center cursor-pointer hover:text-blue-600 transition duration-200">
                <img src="https://placehold.co/60x60/FFDDC1/FFFFFF?text=Beauty" alt="บิวตี้ช็อป" class="rounded-full mb-1">
                <span class="text-sm">บิวตี้ช็อป</span>
            </div>
            <div class="category-item flex flex-col items-center cursor-pointer hover:text-blue-600 transition duration-200">
                <img src="https://placehold.co/60x60/D1E7DD/FFFFFF?text=Home" alt="ของใช้" class="rounded-full mb-1">
                <span class="text-sm">ของใช้</span>
            </div>
            <div class="category-item flex flex-col items-center cursor-pointer hover:text-blue-600 transition duration-200">
                <img src="https://placehold.co/60x60/C2E0FF/FFFFFF?text=MomKid" alt="แม่และเด็ก" class="rounded-full mb-1">
                <span class="text-sm">แม่และเด็ก</span>
            </div>
            <div class="category-item flex flex-col items-center cursor-pointer hover:text-blue-600 transition duration-200">
                <img src="https://placehold.co/60x60/FFE0B2/FFFFFF?text=Toys" alt="ของเล่นเด็ก" class="rounded-full mb-1">
                <span class="text-sm">ของเล่นเด็ก</span>
            </div>
            <div class="category-item flex flex-col items-center cursor-pointer hover:text-blue-600 transition duration-200">
                <img src="https://placehold.co/60x60/E0BBE4/FFFFFF?text=Gifts" alt="กิฟต์ช็อป" class="rounded-full mb-1">
                <span class="text-sm">กิฟต์ช็อป</span>
            </div>
            <!-- Add more categories as needed -->
        </div>
    </nav>

    <!-- Participating Stores Section -->
    <section class="container mx-auto p-4 mt-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">ร้านที่ร่วมรายการ</h2>
        <div class="rounded-xl shadow-md p-4 overflow-x-auto whitespace-nowrap">
            <div class="flex space-x-4">
                <div class="store-item flex flex-col items-center cursor-pointer hover:opacity-75 transition duration-200">
                    <img src="https://placehold.co/80x80/B3E0FF/FFFFFF?text=Store1" alt="Store 1" class="rounded-lg mb-1">
                    <span class="text-xs text-gray-700">Store Name 1</span>
                </div>
                <div class="store-item flex flex-col items-center cursor-pointer hover:opacity-75 transition duration-200">
                    <img src="https://placehold.co/80x80/FFB3BA/FFFFFF?text=Store2" alt="Store 2" class="rounded-lg mb-1">
                    <span class="text-xs text-gray-700">Store Name 2</span>
                </div>
                <div class="store-item flex flex-col items-center cursor-pointer hover:opacity-75 transition duration-200">
                    <img src="https://placehold.co/80x80/BAFFC9/FFFFFF?text=Store3" alt="Store 3" class="rounded-lg mb-1">
                    <span class="text-xs text-gray-700">Store Name 3</span>
                </div>
                <div class="store-item flex flex-col items-center cursor-pointer hover:opacity-75 transition duration-200">
                    <img src="https://placehold.co/80x80/FFFFB3/FFFFFF?text=Store4" alt="Store 4" class="rounded-lg mb-1">
                    <span class="text-xs text-gray-700">Store Name 4</span>
                </div>
                <div class="store-item flex flex-col items-center cursor-pointer hover:opacity-75 transition duration-200">
                    <img src="https://placehold.co/80x80/E0BBE4/FFFFFF?text=Store5" alt="Store 5" class="rounded-lg mb-1">
                    <span class="text-xs text-gray-700">Store Name 5</span>
                </div>
                <div class="store-item flex flex-col items-center cursor-pointer hover:opacity-75 transition duration-200">
                    <img src="https://placehold.co/80x80/FFDDC1/FFFFFF?text=Store6" alt="Store 6" class="rounded-lg mb-1">
                    <span class="text-xs text-gray-700">Store Name 6</span>
                </div>
                <!-- Add more store items as needed -->
            </div>
        </div>
    </section>


    <!-- Main Content Area (Recommended Products) -->
    <main id="main-content" class="container mx-auto p-4 mt-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">สินค้าแนะนำ</h2>
        <!-- Content will be rendered here by JavaScript -->
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white p-6 mt-8">
        <div class="container mx-auto text-center text-sm">
            <p>&copy; 2023 Moon Delivery. สงวนลิขสิทธิ์.</p>
            <p class="mt-2">สร้างขึ้นเพื่อการสาธิตเท่านั้น</p>
        </div>
    </footer>

    <!-- Hidden Receipt Container (for image generation) -->
    <div id="receipt-container">
        <!-- Receipt content will be dynamically generated here -->
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // --- Global State Variables ---
        let currentPage = 'home'; // 'home', 'productDetail', 'cart', 'adminPanel'
        let selectedProductId = null;
        let cartItems = [];
        let searchTerm = '';
        let currentEditingProduct = null; // To store product being edited
        let currentEditingSeller = null; // To store seller being edited

        // Mock Data (will not persist on page refresh) - This will be replaced by API calls
        let products = []; // Initialize as empty, data will come from API
        let sellers = []; // Initialize as empty, data will come from API

        // --- DOM Elements ---
        const mainContent = document.getElementById('main-content');
        const cartItemCountSpan = document.getElementById('cart-item-count');
        const searchInput = document.getElementById('search-input');
        const cartButton = document.getElementById('cart-button');
        const adminPanelButton = document.getElementById('admin-panel-button');


        // --- Custom Alert/Message Box ---
        const customAlertModal = document.getElementById('custom-alert-modal');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertOkButton = document.getElementById('custom-alert-ok-button');

        function showCustomAlert(message) {
            customAlertMessage.textContent = message;
            customAlertModal.classList.add('show');
        }

        customAlertOkButton.addEventListener('click', () => {
            customAlertModal.classList.remove('show');
        });

        // --- Password Modal ---
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('password-input');
        const passwordSubmitButton = document.getElementById('password-submit-button');
        const passwordCancelButton = document.getElementById('password-cancel-button');
        const ADMIN_PASSWORD = 'B11'; // Define the password here

        function showPasswordModal() {
            passwordInput.value = ''; // Clear input field
            passwordModal.classList.add('show');
            passwordInput.focus(); // Focus on the input field
        }

        function hidePasswordModal() {
            passwordModal.classList.remove('show');
        }

        passwordSubmitButton.addEventListener('click', () => {
            const enteredPassword = passwordInput.value;
            if (enteredPassword === ADMIN_PASSWORD) {
                hidePasswordModal();
                navigateTo('adminPanel');
            } else {
                showCustomAlert('รหัสผ่านไม่ถูกต้อง!');
                passwordInput.value = ''; // Clear input on wrong password
            }
        });

        passwordCancelButton.addEventListener('click', () => {
            hidePasswordModal();
        });

        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                passwordSubmitButton.click(); // Simulate click on submit button
            }
        });

        // --- API Base URLs ---
        const API_BASE_URL = 'http://localhost/my_ecommerce_api'; // Base URL for your PHP API
        const PRODUCTS_API_URL = `${API_BASE_URL}/products.php`;
        const SELLERS_API_URL = `${API_BASE_URL}/sellers.php`; // New API URL for sellers

        // --- Helper Functions ---
        function getSellerById(sellerId) {
            return sellers.find(seller => seller.id == sellerId); // Use == for loose comparison
        }

        function updateCartItemCount() {
            const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
            cartItemCountSpan.textContent = totalItems;
            if (totalItems > 0) {
                cartItemCountSpan.classList.remove('hidden');
            } else {
                cartItemCountSpan.classList.add('hidden');
            }
        }

        function navigateTo(page, id = null) {
            currentPage = page;
            selectedProductId = id;
            renderPage();
        }

        // --- Fetch Data from APIs ---
        async function fetchProductsFromAPI() {
            console.log('Fetching products from:', PRODUCTS_API_URL);
            try {
                const response = await fetch(PRODUCTS_API_URL);
                console.log('Products API response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Products fetched:', data);
                return data;
            } catch (error) {
                console.error('Error fetching products from API:', error);
                showCustomAlert('ไม่สามารถดึงข้อมูลสินค้าได้: ' + error.message);
                return [];
            }
        }

        async function fetchSellersFromAPI() {
            console.log('Fetching sellers from:', SELLERS_API_URL);
            try {
                const response = await fetch(SELLERS_API_URL);
                console.log('Sellers API response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Sellers fetched:', data);
                return data;
            } catch (error) {
                console.error('Error fetching sellers from API:', error);
                showCustomAlert('ไม่สามารถดึงข้อมูลผู้ขายได้: ' + error.message);
                return [];
            }
        }

        // --- Render Functions for Pages ---

        async function renderHomePage() {
            mainContent.innerHTML = '';

            const allProducts = await fetchProductsFromAPI();
            products = allProducts; // Update global products array

            // Fetch sellers to ensure dropdown is populated correctly for filtering
            const allSellers = await fetchSellersFromAPI();
            sellers = allSellers; // Update global sellers array

            const activeSellerIds = sellers.filter(s => s.status === 'active').map(s => s.id);

            const filteredProducts = products.filter(product =>
                activeSellerIds.includes(product.seller_id) &&
                (product.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                product.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                getSellerById(product.seller_id)?.name.toLowerCase().includes(searchTerm.toLowerCase()))
            );

            const productGrid = document.createElement('div');
            // Changed grid columns to 6 for large screens to match the new design density
            productGrid.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 lg:grid-cols-8 gap-4'; /* Adjusted grid columns */

            if (filteredProducts.length === 0) {
                productGrid.innerHTML = `
                    <div class="col-span-full text-center text-gray-600 text-lg py-10">
                        ไม่พบสินค้าที่ตรงกับการค้นหาของคุณ
                    </div>
                `;
            } else {
                filteredProducts.forEach(product => {
                    // const seller = getSellerById(product.seller_id); // Seller info removed from product card
                    const productCard = document.createElement('div');
                    productCard.className = 'bg-white rounded-xl shadow-md overflow-hidden transform transition duration-300 hover:scale-105 hover:shadow-lg cursor-pointer flex flex-col';
                    productCard.dataset.productId = product.id;

                    productCard.innerHTML = `
                        <img src="${product.image_url}" alt="${product.name}" class="product-card-image rounded-t-xl" onerror="this.onerror=null;this.src='https://placehold.co/300x300/CCCCCC/333333?text=Image+Error';">
                        <div class="p-2 flex-grow flex flex-col justify-between">
                            <div>
                                <h3 class="text-sm font-semibold text-gray-800 mb-1 line-clamp-2">${product.name}</h3>
                                <!-- Removed seller, rating, reviews from product card to match new design -->
                            </div>
                            <div class="flex justify-between items-end mt-2">
                                <p class="text-lg font-bold text-red-600">฿${parseFloat(product.price).toLocaleString()}</p>
                                <button class="add-to-cart-button bg-blue-600 text-white p-1 rounded-full hover:bg-blue-700 transition duration-200">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    productGrid.appendChild(productCard);

                    productCard.addEventListener('click', (e) => {
                        // Only navigate to product detail if the click is not on the add to cart button
                        if (!e.target.closest('.add-to-cart-button')) {
                            navigateTo('productDetail', product.id);
                        }
                    });

                    productCard.querySelector('.add-to-cart-button').addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent the parent card's click event from firing
                        handleAddToCart(product);
                    });
                });
            }
            mainContent.appendChild(productGrid);
            lucide.createIcons();
        }

        async function renderProductDetailPage() {
            mainContent.innerHTML = '';
            let product = null;

            if (selectedProductId) {
                try {
                    const response = await fetch(`${PRODUCTS_API_URL}?id=${selectedProductId}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    if (data.length > 0) {
                        product = data[0];
                        product.price = parseFloat(product.price);
                        product.rating = parseFloat(product.rating);
                        product.reviews = parseInt(product.reviews);
                        product.stock = parseInt(product.stock);
                    }
                } catch (error) {
                    console.error('Error fetching product detail:', error);
                    showCustomAlert('ไม่สามารถดึงรายละเอียดสินค้าได้: ' + error.message);
                }
            }

            if (!product) {
                mainContent.innerHTML = `
                    <div class="p-4 text-center text-gray-700">
                        <p>ไม่พบสินค้า</p>
                        <button id="back-to-home-button" class="mt-4 bg-gray-300 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-400 transition duration-200">
                            กลับหน้าหลัก
                        </button>
                    </div>
                `;
                document.getElementById('back-to-home-button').addEventListener('click', () => navigateTo('home'));
                return;
            }

            const seller = getSellerById(product.seller_id);

            const detailPageHtml = `
                <button id="back-to-shopping-button" class="mb-4 flex items-center text-blue-600 hover:text-blue-800 transition duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    กลับไปช้อปปิ้ง
                </button>

                <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 flex flex-col md:flex-row gap-6 md:gap-8">
                    <div class="md:w-1/2 flex justify-center items-center">
                        <img src="${product.image_url}" alt="${product.name}" class="product-detail-image" onerror="this.onerror=null;this.src='https://placehold.co/400x400/CCCCCC/333333?text=Image+Error';">
                    </div>
                    <div class="md:w-1/2">
                        <h1 class="text-3xl font-bold text-gray-900 mb-3">${product.name}</h1>
                        <p class="text-2xl font-bold text-red-600 mb-4">฿${product.price.toLocaleString()}</p>

                        <div class="flex items-center text-gray-700 mb-4">
                            <i data-lucide="star" class="w-5 h-5 text-yellow-400 mr-2" fill="currentColor"></i>
                            <span class="text-lg font-semibold">${product.rating.toFixed(1)}</span>
                            <span class="text-md ml-2">(${product.reviews} รีวิว)</span>
                        </div>

                        <p class="text-gray-800 mb-6 leading-relaxed">${product.description}</p>

                        <div class="bg-gray-100 p-4 rounded-lg mb-6">
                            <h2 class="text-xl font-semibold text-gray-800 mb-3 flex items-center">
                                <i data-lucide="store" class="w-5 h-5 mr-2 text-blue-500"></i>
                                ร้านค้า: ${seller ? seller.name : 'ไม่ระบุผู้ขาย'}
                            </h2>
                            ${seller ? `
                                <p class="text-gray-700 flex items-center mb-1">
                                    <i data-lucide="map-pin" class="w-4 h-4 mr-2 text-gray-600"></i>
                                    ที่ตั้ง: ${seller.location}
                                </p>
                                <p class="text-gray-700 flex items-center mb-1">
                                    <i data-lucide="phone" class="w-4 h-4 mr-2 text-gray-600"></i>
                                    ติดต่อ: ${seller.contact}
                                </p>
                                <p class="text-gray-700 flex items-center">
                                    <i data-lucide="user" class="w-4 h-4 mr-2 text-gray-600"></i>
                                    รายละเอียด: ${seller.description}
                                </p>
                            ` : ''}
                        </div>

                        <button id="detail-add-to-cart-button" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg text-lg font-semibold hover:bg-blue-700 transition duration-200 shadow-lg">
                            <i data-lucide="shopping-cart" class="inline-block w-5 h-5 mr-2"></i>
                            เพิ่มลงตะกร้า
                        </button>
                    </div>
                </div>
            `;
            mainContent.innerHTML = detailPageHtml;
            lucide.createIcons();

            document.getElementById('back-to-shopping-button').addEventListener('click', () => navigateTo('home'));
            document.getElementById('detail-add-to-cart-button').addEventListener('click', () => handleAddToCart(product));
        }

        function renderCartPage() {
            mainContent.innerHTML = '';
            const total = cartItems.reduce((sum, item) => sum + item.price * item.quantity, 0);

            let cartHtml = `
                <button id="back-from-cart-button" class="mb-4 flex items-center text-blue-600 hover:text-blue-800 transition duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    กลับไปช้อปปิ้ง
                </button>

                <h1 class="text-3xl font-bold text-gray-900 mb-6">ตะกร้าสินค้า</h1>
            `;

            if (cartItems.length === 0) {
                cartHtml += `
                    <div class="text-center text-gray-600 text-lg">
                        <p>ไม่มีสินค้าในตะกร้า</p>
                        <button id="start-shopping-button" class="mt-6 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200">
                            เริ่มช้อปปิ้ง
                        </button>
                    </div>
                `;
            } else {
                cartHtml += `
                    <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
                        ${cartItems.map(item => `
                            <div class="flex items-center border-b border-gray-200 py-4 last:border-b-0">
                                <img src="${item.image}" alt="${item.name}" class="w-20 h-20 object-cover rounded-md mr-4" onerror="this.onerror=null;this.src='https://placehold.co/80x80/CCCCCC/333333?text=Image';">
                                <div class="flex-grow">
                                    <h3 class="text-lg font-semibold text-gray-800">${item.name}</h3>
                                    <p class="text-gray-600 text-sm">จำนวน: ${item.quantity}</p>
                                    <p class="text-red-600 font-bold">฿${(item.price * item.quantity).toLocaleString()}</p>
                                </div>
                                <button data-product-id="${item.id}" class="remove-from-cart-button bg-red-500 text-white py-1 px-3 rounded-lg hover:bg-red-600 transition duration-200 text-sm">
                                    ลบ
                                </button>
                            </div>
                        `).join('')}
                        <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200">
                            <span class="text-xl font-bold text-gray-900">รวมทั้งหมด:</span>
                            <span class="text-2xl font-bold text-red-600">฿${total.toLocaleString()}</span>
                        </div>
                        <button id="checkout-button" class="w-full mt-6 bg-green-600 text-white py-3 px-6 rounded-lg text-lg font-semibold hover:bg-green-700 transition duration-200 shadow-lg">
                            ดำเนินการชำระเงิน
                        </button>
                    </div>
                `;
            }
            mainContent.innerHTML = cartHtml;

            if (cartItems.length === 0) {
                document.getElementById('start-shopping-button').addEventListener('click', () => navigateTo('home'));
            } else {
                document.querySelectorAll('.remove-from-cart-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const productId = e.target.dataset.productId;
                        handleRemoveFromCart(productId);
                    });
                });
                // Attach event listener to checkout button
                document.getElementById('checkout-button').addEventListener('click', handleCheckout);
            }
            document.getElementById('back-from-cart-button').addEventListener('click', () => navigateTo('home'));
        }

        // --- Handle Checkout and Generate Receipt ---
        async function handleCheckout() {
            if (cartItems.length === 0) {
                showCustomAlert('ไม่มีสินค้าในตะกร้าเพื่อดำเนินการชำระเงิน!');
                return;
            }

            const receiptContainer = document.getElementById('receipt-container');
            const total = cartItems.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const now = new Date();
            const dateTime = now.toLocaleString('th-TH', {
                year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
            const orderId = `ORDER-${Date.now()}`;

            let receiptContentHtml = `
                <div style="font-family: 'Inter', sans-serif; padding: 20px; width: 100%; box-sizing: border-box; color: #333;">
                    <h2 style="text-align: center; margin-bottom: 15px; font-size: 20px; color: #222;">ใบเสร็จรับเงิน</h2>
                    <div class="receipt-header" style="text-align: center; font-size: 12px; margin-bottom: 10px;">
                        <p>Moon E-commerce</p>
                        <p>วันที่: ${dateTime}</p>
                        <p>รหัสคำสั่งซื้อ: ${orderId}</p>
                        <p>-----------------------------------</p>
                    </div>
                    <div style="margin-bottom: 10px;">
                        ${cartItems.map(item => `
                            <div class="receipt-item" style="display: flex; justify-content: space-between; font-size: 14px; padding: 5px 0; border-bottom: 1px dashed #eee;">
                                <span>${item.name} (x${item.quantity})</span>
                                <span>฿${(item.price * item.quantity).toLocaleString()}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="receipt-total" style="display: flex; justify-content: space-between; font-size: 16px; font-weight: bold; padding-top: 10px; border-top: 1px solid #ddd; margin-top: 10px;">
                        <span>รวมทั้งหมด:</span>
                        <span>฿${total.toLocaleString()}</span>
                    </div>
                    <div class="receipt-footer" style="text-align: center; font-size: 12px; margin-top: 20px; border-top: 1px dashed #eee; padding-top: 10px;">
                        <p>ขอบคุณที่ใช้บริการ!</p>
                        <p>ติดต่อ: contact@moon.com</p>
                    </div>
                </div>
            `;

            receiptContainer.innerHTML = receiptContentHtml;

            // Use html2canvas to capture the receipt container as an image
            try {
                const canvas = await html2canvas(receiptContainer, {
                    scale: 2, // Increase scale for better quality
                    useCORS: true, // Important if images are from external sources
                    logging: false // Disable logging for cleaner console
                });

                // Convert canvas to data URL (PNG)
                const image = canvas.toDataURL('image/png');

                // Create a temporary link element for download
                const link = document.createElement('a');
                link.href = image;
                link.download = `receipt_${orderId}.png`; // Filename for download
                document.body.appendChild(link); // Append to body to make it clickable
                link.click(); // Simulate click to trigger download
                document.body.removeChild(link); // Clean up the temporary link

                // Clear cart and navigate back to home page
                cartItems = [];
                updateCartItemCount();
                showCustomAlert('การชำระเงินสำเร็จ! ใบเสร็จจะถูกดาวน์โหลดโดยอัตโนมัติ');
                navigateTo('home');

            } catch (error) {
                console.error('Error generating receipt image:', error);
                showCustomAlert('เกิดข้อผิดพลาดในการสร้างใบเสร็จ: ' + error.message);
            } finally {
                receiptContainer.innerHTML = ''; // Clear receipt container
            }
        }


        // --- Admin Panel Sub-Components Render Functions ---

        function renderProductManagement() {
            let productManagementHtml = `
                <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i data-lucide="package" class="w-6 h-6 mr-2 text-blue-600"></i>
                        จัดการสินค้า
                    </h2>

                    <!-- Product Add/Edit Form -->
                    <div id="product-form-container" class="bg-gray-50 p-4 border border-gray-200 rounded-lg mb-8">
                        <form id="add-edit-product-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="hidden" id="product-id"> <!-- Hidden input for product ID -->
                            <div class="md:col-span-2">
                                <h3 id="product-form-title" class="text-xl font-semibold text-gray-800 mb-4">เพิ่มสินค้าใหม่</h3>
                            </div>
                            <div>
                                <label for="product-name" class="block text-sm font-medium text-gray-700">ชื่อสินค้า</label>
                                <input type="text" id="product-name" name="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" required>
                            </div>
                            <div>
                                <label for="product-price" class="block text-sm font-medium text-gray-700">ราคา (฿)</label>
                                <input type="number" id="product-price" name="price" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" min="0" step="0.01" required>
                            </div>
                            <div class="md:col-span-2">
                                <label for="product-description" class="block text-sm font-medium text-gray-700">คำอธิบาย</label>
                                <textarea id="product-description" name="description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2"></textarea>
                            </div>
                            <div>
                                <label for="product-image" class="block text-sm font-medium text-gray-700">URL รูปภาพ</label>
                                <input type="text" id="product-image" name="image" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="https://..." required>
                            </div>
                            <div>
                                <label for="product-seller-id" class="block text-sm font-medium text-gray-700">ผู้ขาย</label>
                                <select id="product-seller-id" name="sellerId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" required>
                                    <!-- Options will be populated by JavaScript -->
                                </select>
                            </div>
                            <div>
                                <label for="product-rating" class="block text-sm font-medium text-gray-700">เรตติ้ง (0.0-5.0)</label>
                                <input type="number" id="product-rating" name="rating" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" min="0" max="5" step="0.1" value="0.0">
                            </div>
                            <div>
                                <label for="product-reviews" class="block text-sm font-medium text-gray-700">จำนวนรีวิว</label>
                                <input type="number" id="product-reviews" name="reviews" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" min="0" value="0">
                            </div>
                            <div>
                                <label for="product-stock" class="block text-sm font-medium text-gray-700">สต็อก</label>
                                <input type="number" id="product-stock" name="stock" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" min="0" required>
                            </div>
                            <div class="md:col-span-2 flex justify-end space-x-3">
                                <button type="submit" id="submit-product-button" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    <i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i>
                                    เพิ่มสินค้า
                                </button>
                                <button type="button" id="cancel-product-form" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    ยกเลิก
                                </button>
                            </div>
                        </form>
                    </div>

                    <button id="show-product-form-button" class="mb-6 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 hidden">
                        <i data-lucide="plus" class="w-4 h-4 mr-2"></i> เพิ่มสินค้าใหม่
                    </button>

                    <!-- Product List -->
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">รายการสินค้าทั้งหมด</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">รูปภาพ</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สินค้า</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ราคา</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ผู้ขาย</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สต็อก</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เรตติ้ง</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">รีวิว</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">การดำเนินการ</th>
                                </tr>
                            </thead>
                            <tbody id="product-list-body" class="bg-white divide-y divide-gray-200">
                                <!-- Product rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            const productManagementContainer = document.createElement('div');
            productManagementContainer.innerHTML = productManagementHtml;
            return productManagementContainer;
        }

        async function populateProductList() {
            const productListBody = document.getElementById('product-list-body');
            if (!productListBody) return;

            try {
                const allProducts = await fetchProductsFromAPI();
                products = allProducts; // Update global products array

                // Also fetch sellers to ensure the seller dropdown is up-to-date
                const allSellers = await fetchSellersFromAPI();
                sellers = allSellers;

                productListBody.innerHTML = ''; // Clear existing rows

                if (products.length === 0) {
                    productListBody.innerHTML = `<tr><td colspan="9" class="py-4 text-center text-gray-500">ไม่มีสินค้าในระบบ.</td></tr>`;
                    return;
                }

                products.forEach(product => {
                    const seller = getSellerById(product.seller_id);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${product.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <img class="h-10 w-10 rounded-full object-cover" src="${product.image_url}" alt="${product.name}" onerror="this.onerror=null;this.src='https://placehold.co/40x40/CCCCCC/333333?text=Img';">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${product.name}</div>
                            <div class="text-sm text-gray-500 line-clamp-1">${product.description}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">฿${parseFloat(product.price).toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${seller ? seller.name : 'ไม่ระบุ'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.stock}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${parseFloat(product.rating).toFixed(1)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.reviews}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button data-product-id="${product.id}" class="edit-product-button text-indigo-600 hover:text-indigo-900 mr-3">
                                <i data-lucide="edit" class="w-4.5 h-4.5"></i>
                            </button>
                            <button data-product-id="${product.id}" class="delete-product-button text-red-600 hover:text-red-900">
                                <i data-lucide="trash-2" class="w-4.5 h-4.5"></i>
                            </button>
                        </td>
                    `;
                    productListBody.appendChild(row);
                });
                lucide.createIcons();

                // Add event listeners for edit and delete buttons
                productListBody.querySelectorAll('.edit-product-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const productId = e.currentTarget.dataset.productId;
                        const productToEdit = products.find(p => p.id == productId);
                        if (productToEdit) {
                            currentEditingProduct = productToEdit;
                            document.getElementById('product-id').value = productToEdit.id;
                            document.getElementById('product-name').value = productToEdit.name;
                            document.getElementById('product-description').value = productToEdit.description;
                            document.getElementById('product-price').value = productToEdit.price;
                            document.getElementById('product-image').value = productToEdit.image_url;
                            document.getElementById('product-seller-id').value = productToEdit.seller_id;
                            document.getElementById('product-rating').value = productToEdit.rating;
                            document.getElementById('product-reviews').value = productToEdit.reviews;
                            document.getElementById('product-stock').value = productToEdit.stock;

                            document.getElementById('product-form-title').textContent = 'แก้ไขสินค้า';
                            document.getElementById('submit-product-button').innerHTML = `<i data-lucide="edit" class="w-4 h-4 mr-2"></i> บันทึกการแก้ไข`;
                            document.getElementById('product-form-container').classList.remove('hidden');
                            lucide.createIcons();
                        }
                    });
                });

                productListBody.querySelectorAll('.delete-product-button').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const productId = e.currentTarget.dataset.productId;
                        if (confirm('คุณแน่ใจหรือไม่ที่ต้องการลบสินค้านี้?')) {
                            try {
                                const response = await fetch(`${PRODUCTS_API_URL}?id=${productId}`, {
                                    method: 'DELETE'
                                });
                                const result = await response.json();
                                if (response.ok && result.message === "Product deleted successfully") {
                                    showCustomAlert('สินค้าถูกลบเรียบร้อยแล้ว!');
                                    await populateProductList();
                                } else {
                                    throw new Error(result.message || 'เกิดข้อผิดพลาดในการลบสินค้า');
                                }
                            } catch (error) {
                                console.error('Error deleting product:', error);
                                showCustomAlert('ลบสินค้าไม่สำเร็จ: ' + error.message);
                            }
                        }
                    });
                });

            } catch (error) {
                console.error('Error fetching products for admin list:', error);
                productListBody.innerHTML = `<tr><td colspan="9" class="py-4 text-center text-red-500">เกิดข้อผิดพลาดในการโหลดสินค้า: ${error.message}</td></tr>`;
            }
        }

        async function setupProductFormEvents() {
            const addEditProductForm = document.getElementById('add-edit-product-form');
            const productIdInput = document.getElementById('product-id');
            const productNameInput = document.getElementById('product-name');
            const productDescriptionInput = document.getElementById('product-description');
            const productPriceInput = document.getElementById('product-price');
            const productImageInput = document.getElementById('product-image');
            const productSellerIdInput = document.getElementById('product-seller-id');
            const productRatingInput = document.getElementById('product-rating');
            const productReviewsInput = document.getElementById('product-reviews');
            const productStockInput = document.getElementById('product-stock');
            const formTitle = document.getElementById('product-form-title');
            const submitButton = document.getElementById('submit-product-button');
            const cancelButton = document.getElementById('cancel-product-form');

            // Populate seller dropdown from API
            const allSellers = await fetchSellersFromAPI();
            sellers = allSellers; // Update global sellers array
            const sellerOptionsHtml = sellers.map(seller => `<option value="${seller.id}">${seller.name}</option>`).join('');
            productSellerIdInput.innerHTML = `<option value="">เลือกร้านค้า</option>${sellerOptionsHtml}`;

            if (addEditProductForm) {
                addEditProductForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const productData = {
                        // ID is only included for PUT requests (editing existing product)
                        // For POST (new product), the database will generate the ID
                        name: productNameInput.value,
                        description: productDescriptionInput.value,
                        price: parseFloat(productPriceInput.value),
                        image: productImageInput.value, // PHP API expects 'image'
                        sellerId: productSellerIdInput.value, // PHP API expects 'sellerId'
                        rating: parseFloat(productRatingInput.value),
                        reviews: parseInt(productReviewsInput.value),
                        stock: parseInt(productStockInput.value)
                    };

                    // Basic validation
                    if (!productData.name || !productData.description || isNaN(productData.price) || productData.price < 0 || !productData.image || !productData.sellerId || isNaN(productData.rating) || productData.rating < 0 || productData.rating > 5 || isNaN(productData.reviews) || productData.reviews < 0 || isNaN(productData.stock) || productData.stock < 0) {
                        showCustomAlert('กรุณากรอกข้อมูลสินค้าให้ครบถ้วนและถูกต้อง (ชื่อ, ราคา, คำอธิบาย, URL รูปภาพ, ผู้ขาย, เรตติ้ง (0-5), รีวิว, สต็อก)');
                        return;
                    }

                    if (currentEditingProduct) {
                        // Update existing product
                        try {
                            // Add ID to productData for PUT request
                            productData.id = productIdInput.value;
                            const response = await fetch(`${PRODUCTS_API_URL}?id=${productData.id}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(productData)
                            });
                            const result = await response.json();
                            if (response.ok && result.message === "Product updated successfully") {
                                showCustomAlert('สินค้าถูกแก้ไขเรียบร้อยแล้ว!');
                                await populateProductList(); // Re-render the list in Admin
                                addEditProductForm.reset();
                                document.getElementById('product-form-container').classList.add('hidden');
                                currentEditingProduct = null;
                            } else {
                                throw new Error(result.message || 'เกิดข้อผิดพลาดในการแก้ไขสินค้า');
                            }
                        } catch (error) {
                            showCustomAlert(`แก้ไขสินค้าไม่สำเร็จ: ${error.message}`);
                            console.error('Error updating product:', error);
                        }
                    } else {
                        // Add new product
                        try {
                            const response = await fetch(PRODUCTS_API_URL, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(productData)
                            });
                            const result = await response.json();
                            if (response.ok && result.message === "Product added successfully") {
                                showCustomAlert('สินค้าถูกเพิ่มเรียบร้อยแล้ว!');
                                await populateProductList(); // Re-render the list in Admin
                                addEditProductForm.reset();
                                document.getElementById('product-form-container').classList.add('hidden');
                            } else {
                                throw new Error(result.message || 'เกิดข้อผิดพลาดในการเพิ่มสินค้า');
                            }
                        } catch (error) {
                            showCustomAlert(`เพิ่มสินค้าไม่สำเร็จ: ${error.message}`);
                            console.error('Error adding new product:', error);
                        }
                    }
                });

                cancelButton.addEventListener('click', () => {
                    addEditProductForm.reset();
                    document.getElementById('product-form-container').classList.add('hidden');
                    currentEditingProduct = null; // Clear editing state
                });
            }
        }

        function renderSellerManagement() {
            const sellerManagementHtml = `
                <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i data-lucide="store" class="w-6 h-6 mr-2 text-blue-600"></i>
                        จัดการผู้ขาย
                    </h2>

                    <!-- Seller Add/Edit Form -->
                    <div id="seller-form-container" class="bg-gray-50 p-4 border border-gray-200 rounded-lg mb-8">
                        <form id="add-edit-seller-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="hidden" id="seller-id">
                            <div class="md:col-span-2">
                                <h3 id="seller-form-title" class="text-xl font-semibold text-gray-800 mb-4">เพิ่มผู้ขายใหม่</h3>
                            </div>
                            <div>
                                <label for="seller-name" class="block text-sm font-medium text-gray-700">ชื่อผู้ขาย</label>
                                <input type="text" id="seller-name" name="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" required>
                            </div>
                            <div>
                                <label for="seller-image" class="block text-sm font-medium text-gray-700">URL รูปภาพผู้ขาย</label>
                                <input type="text" id="seller-image" name="image" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="https://..." required>
                            </div>
                            <div class="md:col-span-2">
                                <label for="seller-description" class="block text-sm font-medium text-gray-700">คำอธิบายผู้ขาย</label>
                                <textarea id="seller-description" name="description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2"></textarea>
                            </div>
                            <div>
                                <label for="seller-location" class="block text-sm font-medium text-gray-700">ที่ตั้ง</label>
                                <input type="text" id="seller-location" name="location" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                            </div>
                            <div>
                                <label for="seller-contact" class="block text-sm font-medium text-gray-700">ติดต่อ</label>
                                <input type="text" id="seller-contact" name="contact" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                            </div>
                            <div>
                                <label for="seller-status" class="block text-sm font-medium text-gray-700">สถานะ</label>
                                <select id="seller-status" name="status" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" required>
                                    <option value="active">ใช้งาน</option>
                                    <option value="pending">รอดำเนินการ</option>
                                    <option value="suspended">ระงับ</option>
                                </select>
                            </div>
                            <div class="md:col-span-2 flex justify-end space-x-3">
                                <button type="submit" id="submit-seller-button" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    <i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i>
                                    เพิ่มผู้ขาย
                                </button>
                                <button type="button" id="cancel-seller-form" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    ยกเลิก
                                </button>
                            </div>
                        </form>
                    </div>

                    <button id="show-seller-form-button" class="mb-6 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 hidden">
                        <i data-lucide="plus" class="w-4 h-4 mr-2"></i> เพิ่มผู้ขายใหม่
                    </button>

                    <!-- Seller List -->
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">รายการผู้ขายทั้งหมด</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">รูปภาพ</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ผู้ขาย</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ที่ตั้ง</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ติดต่อ</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สถานะ</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">การดำเนินการ</th>
                                </tr>
                            </thead>
                            <tbody id="seller-list-body" class="bg-white divide-y divide-gray-200">
                                <!-- Seller rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            const sellerManagementContainer = document.createElement('div');
            sellerManagementContainer.innerHTML = sellerManagementHtml;
            return sellerManagementContainer;
        }

        async function populateSellerList() {
            const sellerListBody = document.getElementById('seller-list-body');
            if (!sellerListBody) return;

            try {
                const allSellers = await fetchSellersFromAPI();
                sellers = allSellers; // Update global sellers array

                sellerListBody.innerHTML = ''; // Clear existing rows

                if (sellers.length === 0) {
                    sellerListBody.innerHTML = `<tr><td colspan="7" class="py-4 text-center text-gray-500">ไม่มีผู้ขายในระบบ.</td></tr>`;
                    return;
                }

                sellers.forEach(seller => {
                    const row = document.createElement('tr');
                    const statusClass = seller.status === 'active' ? 'bg-green-100 text-green-800' :
                                        seller.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                        'bg-red-100 text-red-800';
                    const statusText = seller.status === 'active' ? 'ใช้งาน' :
                                       seller.status === 'pending' ? 'รอดำเนินการ' : 'ระงับ';

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${seller.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <img class="h-10 w-10 rounded-full object-cover" src="${seller.image}" alt="${seller.name}" onerror="this.onerror=null;this.src='https://placehold.co/40x40/CCCCCC/333333?text=Img';">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${seller.name}</div>
                            <div class="text-sm text-gray-500 line-clamp-1">${seller.description}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${seller.location}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${seller.contact}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button data-seller-id="${seller.id}" class="edit-seller-button text-indigo-600 hover:text-indigo-900 mr-3">
                                <i data-lucide="edit" class="w-4.5 h-4.5"></i>
                            </button>
                            <button data-seller-id="${seller.id}" class="delete-seller-button text-red-600 hover:text-red-900">
                                <i data-lucide="trash-2" class="w-4.5 h-4.5"></i>
                            </button>
                        </td>
                    `;
                    sellerListBody.appendChild(row);
                });
                lucide.createIcons();

                // Add event listeners for edit and delete buttons
                sellerListBody.querySelectorAll('.edit-seller-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const sellerId = e.currentTarget.dataset.sellerId;
                        const sellerToEdit = sellers.find(s => s.id == sellerId);
                        if (sellerToEdit) {
                            currentEditingSeller = sellerToEdit;
                            document.getElementById('seller-id').value = sellerToEdit.id;
                            document.getElementById('seller-name').value = sellerToEdit.name;
                            document.getElementById('seller-description').value = sellerToEdit.description;
                            document.getElementById('seller-image').value = sellerToEdit.image;
                            document.getElementById('seller-location').value = sellerToEdit.location;
                            document.getElementById('seller-contact').value = sellerToEdit.contact;
                            document.getElementById('seller-status').value = sellerToEdit.status;

                            document.getElementById('seller-form-title').textContent = 'แก้ไขผู้ขาย';
                            document.getElementById('submit-seller-button').innerHTML = `<i data-lucide="edit" class="w-4 h-4 mr-2"></i> บันทึกการแก้ไข`;
                            document.getElementById('seller-form-container').classList.remove('hidden');
                            lucide.createIcons();
                        }
                    });
                });

                sellerListBody.querySelectorAll('.delete-seller-button').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const sellerId = e.currentTarget.dataset.sellerId;
                        if (confirm('คุณแน่ใจหรือไม่ที่ต้องการลบผู้ขายนี้?')) {
                            try {
                                const response = await fetch(`${SELLERS_API_URL}?id=${sellerId}`, {
                                    method: 'DELETE'
                                });
                                const result = await response.json();
                                if (response.ok && result.message === "Seller deleted successfully") {
                                    showCustomAlert('ผู้ขายถูกลบเรียบร้อยแล้ว!');
                                    await populateSellerList();
                                    await populateProductList(); // Update products list as well, in case a seller was removed
                                } else {
                                    throw new Error(result.message || 'เกิดข้อผิดพลาดในการลบผู้ขาย');
                                }
                            } catch (error) {
                                console.error('Error deleting seller:', error);
                                showCustomAlert('ลบผู้ขายไม่สำเร็จ: ' + error.message);
                            }
                        }
                    });
                });

            } catch (error) {
                console.error('Error fetching sellers for admin list:', error);
                sellerListBody.innerHTML = `<tr><td colspan="7" class="py-4 text-center text-red-500">เกิดข้อผิดพลาดในการโหลดผู้ขาย: ${error.message}</td></tr>`;
            }
        }

        async function setupSellerFormEvents() {
            const addEditSellerForm = document.getElementById('add-edit-seller-form');
            const sellerIdInput = document.getElementById('seller-id');
            const sellerNameInput = document.getElementById('seller-name');
            const sellerDescriptionInput = document.getElementById('seller-description');
            const sellerImageInput = document.getElementById('seller-image');
            const sellerLocationInput = document.getElementById('seller-location');
            const sellerContactInput = document.getElementById('seller-contact');
            const sellerStatusInput = document.getElementById('seller-status');
            const formTitle = document.getElementById('seller-form-title');
            const submitButton = document.getElementById('submit-seller-button');
            const cancelButton = document.getElementById('cancel-seller-form');

            if (addEditSellerForm) {
                addEditSellerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const sellerData = {
                        name: sellerNameInput.value,
                        description: sellerDescriptionInput.value,
                        image: sellerImageInput.value,
                        location: sellerLocationInput.value,
                        contact: sellerContactInput.value,
                        status: sellerStatusInput.value
                    };

                    // Basic validation
                    if (!sellerData.name || !sellerData.image || !sellerData.status) {
                        showCustomAlert('กรุณากรอกชื่อผู้ขาย, URL รูปภาพ และสถานะ');
                        return;
                    }

                    if (currentEditingSeller) {
                        // Update existing seller
                        try {
                            sellerData.id = sellerIdInput.value;
                            const response = await fetch(`${SELLERS_API_URL}?id=${sellerData.id}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(sellerData)
                            });
                            const result = await response.json();
                            if (response.ok && result.message === "Seller updated successfully") {
                                showCustomAlert('ผู้ขายถูกแก้ไขเรียบร้อยแล้ว!');
                                await populateSellerList();
                                await populateProductList(); // Update products list as well, in case seller name changed
                                addEditSellerForm.reset();
                                document.getElementById('seller-form-container').classList.add('hidden');
                                currentEditingSeller = null;
                            } else {
                                throw new Error(result.message || 'เกิดข้อผิดพลาดในการแก้ไขผู้ขาย');
                            }
                        } catch (error) {
                            showCustomAlert(`แก้ไขผู้ขายไม่สำเร็จ: ${error.message}`);
                            console.error('Error updating seller:', error);
                        }
                    } else {
                        // Add new seller
                        try {
                            const response = await fetch(SELLERS_API_URL, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(sellerData)
                            });
                            const result = await response.json();
                            if (response.ok && result.message === "Seller added successfully") {
                                showCustomAlert('ผู้ขายถูกเพิ่มเรียบร้อยแล้ว!');
                                await populateSellerList();
                                await populateProductList(); // Update products list as well, in case new seller is active
                                addEditSellerForm.reset();
                                document.getElementById('seller-form-container').classList.add('hidden');
                            } else {
                                throw new Error(result.message || 'เกิดข้อผิดพลาดในการเพิ่มผู้ขาย');
                            }
                        } catch (error) {
                            showCustomAlert(`เพิ่มผู้ขายไม่สำเร็จ: ${error.message}`);
                            console.error('Error adding new seller:', error);
                        }
                    }
                });

                cancelButton.addEventListener('click', () => {
                    addEditSellerForm.reset();
                    document.getElementById('seller-form-container').classList.add('hidden');
                    currentEditingSeller = null;
                });
            }
        }


        function renderOrderManagement() {
            return `
                <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i data-lucide="shopping-cart" class="w-6 h-6 mr-2 text-blue-600"></i>
                        จัดการคำสั่งซื้อ
                    </h2>
                    <p class="text-gray-700">
                        หน้านี้จะแสดงรายการคำสั่งซื้อทั้งหมด สถานะการจัดส่ง และรายละเอียดการชำระเงิน
                        ผู้ดูแลระบบสามารถอัปเดตสถานะคำสั่งซื้อ คืนเงิน หรือยกเลิกคำสั่งซื้อได้
                    </p>
                    <p class="mt-4 text-gray-500 text-sm">(ฟังก์ชันนี้ยังไม่สามารถใช้งานได้จริงในเวอร์ชันสาธิตนี้)</p>
                </div>
            `;
        }

        function renderReportsStatistics() {
            return `
                <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i data-lucide="bar-chart-2" class="w-6 h-6 mr-2 text-blue-600"></i>
                        รายงานและสถิติ
                    </h2>
                    <p class="text-gray-700">
                        หน้านี้จะแสดงข้อมูลเชิงลึกเกี่ยวกับยอดขาย สินค้าที่ได้รับความนิยม ผู้ขายที่มีประสิทธิภาพ
                        และข้อมูลอื่นๆ ที่เป็นประโยชน์สำหรับการตัดสินใจทางธุรกิจ
                    </p>
                    <p class="mt-4 text-gray-500 text-sm">(ฟังก์ชันนี้ยังไม่สามารถใช้งานได้จริงในเวอร์ชันสาธิตนี้)</p>
                </div>
            `;
        }

        function renderPromotionManagement() {
            return `
                <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i data-lucide="gift" class="w-6 h-6 mr-2 text-blue-600"></i>
                        จัดการโปรโมชันและส่วนลด
                    </h2>
                    <p class="text-gray-700">
                        หน้านี้จะอนุญาตให้ผู้ดูแลระบบสร้าง จัดการ และติดตามแคมเปญโปรโมชัน
                        เช่น โค้ดส่วนลด, แฟลชเซลล์, หรือโปรโมชันพิเศษต่างๆ
                    </p>
                    <p class="mt-4 text-gray-500 text-sm">(ฟังก์ชันนี้ยังไม่สามารถใช้งานได้จริงในเวอร์ชันสาธิตนี้)</p>
                </div>
            `;
        }

        function renderUserManagement() {
            return `
                <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i data-lucide="users" class="w-6 h-6 mr-2 text-blue-600"></i>
                        จัดการผู้ใช้งาน
                    </h2>
                    <p class="text-gray-700">
                        หน้านี้จะแสดงรายชื่อผู้ใช้งานทั้งหมด รวมถึงข้อมูลโปรไฟล์ สิทธิ์การเข้าถึง
                        และประวัติการทำธุรกรรม ผู้ดูแลระบบสามารถจัดการบัญชีผู้ใช้ได้
                    </p>
                    <p class="mt-4 text-gray-500 text-sm">(ฟังก์ชันนี้ยังไม่สามารถใช้งานได้จริงในเวอร์ชันสาธิตนี้)</p>
                </div>
            `;
        }

        function renderAdminPanel() {
            mainContent.innerHTML = ''; // Clear previous content
            let activeAdminTab = 'products'; // Default active tab for admin panel

            const adminPanelHtml = `
                <div class="p-4 md:p-8 bg-gray-50 min-h-screen flex flex-col lg:flex-row">
                    <div class="lg:w-1/4 lg:pr-8 mb-6 lg:mb-0">
                        <button id="back-from-admin-button" class="mb-4 flex items-center text-blue-600 hover:text-blue-800 transition duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                            กลับหน้าหลัก
                        </button>

                        <h1 class="text-3xl font-bold text-gray-900 mb-6 flex items-center">
                            <i data-lucide="settings" class="w-7 h-7 mr-3 text-gray-700"></i>
                            แผงควบคุม
                        </h1>

                        <!-- Admin Sidebar Navigation -->
                        <nav class="bg-white rounded-xl shadow-lg p-4">
                            <ul class="space-y-2 admin-sidebar">
                                <li>
                                    <button data-tab="products" class="w-full text-left flex items-center p-3 rounded-lg transition duration-200">
                                        <i data-lucide="package" class="w-5 h-5 mr-3"></i>
                                        จัดการสินค้า
                                    </button>
                                </li>
                                <li>
                                    <button data-tab="sellers" class="w-full text-left flex items-center p-3 rounded-lg transition duration-200">
                                        <i data-lucide="store" class="w-5 h-5 mr-3"></i>
                                        จัดการผู้ขาย
                                    </button>
                                </li>
                                <li>
                                    <button data-tab="orders" class="w-full text-left flex items-center p-3 rounded-lg transition duration-200">
                                        <i data-lucide="shopping-cart" class="w-5 h-5 mr-3"></i>
                                        จัดการคำสั่งซื้อ
                                    </button>
                                </li>
                                <li>
                                    <button data-tab="reports" class="w-full text-left flex items-center p-3 rounded-lg transition duration-200">
                                        <i data-lucide="bar-chart-2" class="w-5 h-5 mr-3"></i>
                                        รายงานและสถิติ
                                    </button>
                                </li>
                                <li>
                                    <button data-tab="promotions" class="w-full text-left flex items-center p-3 rounded-lg transition duration-200">
                                        <i data-lucide="gift" class="w-5 h-5 mr-3"></i>
                                        จัดการโปรโมชัน
                                    </button>
                                </li>
                                <li>
                                    <button data-tab="users" class="w-full text-left flex items-center p-3 rounded-lg transition duration-200">
                                        <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                                        จัดการผู้ใช้งาน
                                    </button>
                                </li>
                            </ul>
                        </nav>
                    </div>

                    <div id="admin-content-area" class="lg:w-3/4">
                        <!-- Tab content will be rendered here -->
                    </div>
                </div>
            `;
            mainContent.innerHTML = adminPanelHtml;
            lucide.createIcons();

            // Setup event listeners for sidebar tabs
            const adminContentArea = document.getElementById('admin-content-area');
            const sidebarButtons = document.querySelectorAll('.admin-sidebar button');

            function updateAdminTabContent(tabName) {
                adminContentArea.innerHTML = ''; // Clear previous tab content
                sidebarButtons.forEach(btn => btn.classList.remove('active')); // Remove active class from all buttons

                let content;
                switch (tabName) {
                    case 'products':
                        content = renderProductManagement();
                        break;
                    case 'sellers':
                        content = renderSellerManagement();
                        break;
                    case 'orders':
                        content = renderOrderManagement();
                        break;
                    case 'reports':
                        content = renderReportsStatistics();
                        break;
                    case 'promotions':
                        content = renderPromotionManagement();
                        break;
                    case 'users':
                        content = renderUserManagement();
                        break;
                    default:
                        content = `<p class="text-gray-700">เลือกเมนูเพื่อเริ่มต้นการจัดการ</p>`;
                }
                if (typeof content === 'string') {
                    adminContentArea.innerHTML = content;
                } else {
                    adminContentArea.appendChild(content);
                }

                // Add active class to the clicked button
                document.querySelector(`.admin-sidebar button[data-tab="${tabName}"]`).classList.add('active');

                lucide.createIcons(); // Re-render Lucide icons for new tab content

                // Specific setup for product/seller management after rendering
                if (tabName === 'products') {
                    populateProductList();
                    setupProductFormEvents();
                    document.getElementById('show-product-form-button').addEventListener('click', () => {
                        document.getElementById('product-form-container').classList.remove('hidden');
                        document.getElementById('add-edit-product-form').reset();
                        document.getElementById('product-form-title').textContent = 'เพิ่มสินค้าใหม่';
                        document.getElementById('submit-product-button').innerHTML = `<i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i> เพิ่มสินค้า`;
                        currentEditingProduct = null;
                        lucide.createIcons();
                    });
                } else if (tabName === 'sellers') {
                    populateSellerList();
                    setupSellerFormEvents(); // Setup seller form events
                    document.getElementById('show-seller-form-button').addEventListener('click', () => {
                        document.getElementById('seller-form-container').classList.remove('hidden');
                        document.getElementById('add-edit-seller-form').reset();
                        document.getElementById('seller-form-title').textContent = 'เพิ่มผู้ขายใหม่';
                        document.getElementById('submit-seller-button').innerHTML = `<i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i> เพิ่มผู้ขาย`;
                        currentEditingSeller = null;
                        lucide.createIcons();
                    });
                }
            }

            sidebarButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    activeAdminTab = e.currentTarget.dataset.tab;
                    updateAdminTabContent(activeAdminTab);
                });
            });

            // Initial render of the default tab
            updateAdminTabContent(activeAdminTab);

            document.getElementById('back-from-admin-button').addEventListener('click', () => navigateTo('home'));
        }

        // --- Main Render Function ---
        async function renderPage() {
            updateCartItemCount();
            switch (currentPage) {
                case 'home':
                    await renderHomePage();
                    break;
                case 'productDetail':
                    await renderProductDetailPage();
                    break;
                case 'cart':
                    renderCartPage();
                    break;
                case 'adminPanel':
                    renderAdminPanel();
                    break;
                default:
                    await renderHomePage();
            }
        }

        // --- Event Listeners for Header Buttons ---
        // Moved homeButton declaration and event listener inside DOMContentLoaded
        // homeButton.addEventListener('click', () => navigateTo('home')); // This line caused the error
        cartButton.addEventListener('click', () => navigateTo('cart'));
        
        adminPanelButton.addEventListener('click', () => {
            showPasswordModal();
        });

        searchInput.addEventListener('input', async (e) => {
            searchTerm = e.target.value;
            if (currentPage === 'home') {
                await renderHomePage();
            }
        });

        // --- Initial App Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Declare homeButton here, inside DOMContentLoaded
            const homeButton = document.getElementById('home-button');
            if (homeButton) { // Check if homeButton exists before adding listener
                homeButton.addEventListener('click', () => navigateTo('home'));
            }
            await renderPage();
        });

        // --- Cart Logic ---
        function handleAddToCart(product) {
            const existingItemIndex = cartItems.findIndex(item => item.id === product.id);
            if (existingItemIndex > -1) {
                cartItems[existingItemIndex].quantity += 1;
            } else {
                cartItems.push({
                    id: product.id,
                    name: product.name,
                    price: parseFloat(product.price),
                    image: product.image_url,
                    quantity: 1
                });
            }
            showCustomAlert(`${product.name} ถูกเพิ่มลงในตะกร้าแล้ว!`);
            updateCartItemCount();
        }

        function handleRemoveFromCart(productId) {
            cartItems = cartItems.filter(item => item.id !== productId);
            showCustomAlert('สินค้าถูกลบออกจากตะกร้าแล้ว!');
            renderCartPage();
            updateCartItemCount();
        }

    </script>
</body>
</html>
